{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container-fluid pb-5 mb-5"> <!-- Added padding/margin bottom for fixed footer -->
    <div class="row">
        <div class="col-12">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                <div>
                    <h2><i class="fas fa-book-open me-2"></i>{{ titulo }}</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('gestionar_profesores') }}">Profesores</a></li>
                            <li class="breadcrumb-item active">Asignar Materias</li>
                        </ol>
                    </nav>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-2 fs-6">{{ profesor.get_rol_display() }}</span>
                    <a href="{{ url_for('gestionar_profesores') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>

            <!-- Sticky Toolbar -->
            <div class="sticky-top bg-white border-bottom shadow-sm py-3 mb-4" style="top: 0; z-index: 1020;">
                <div class="container-fluid px-0">
                    <div class="row g-2 align-items-center">
                        <!-- Filtro Carrera -->
                        <div class="col-md-auto">
                            <label class="small text-muted d-block mb-1">Carrera:</label>
                            <div class="btn-group" role="group" id="filtro-carreras">
                                <button type="button" class="btn btn-sm btn-outline-primary active" data-carrera="todas" onclick="filtrar('carrera', 'todas')">
                                    Todas
                                </button>
                                {% for carrera in profesor.carreras %}
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        data-carrera="{{ carrera.codigo }}" 
                                        onclick="filtrar('carrera', '{{ carrera.codigo }}')"
                                        style="border-left: 3px solid {{ loop.cycle('#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6') }};">
                                    {{ carrera.codigo }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Filtro Cuatrimestre -->
                        <div class="col-md-auto border-start ps-3">
                            <label class="small text-muted d-block mb-1">Cuatrimestres:</label>
                            <div class="btn-group flex-wrap" role="group" id="filtro-cuatris">
                                <button type="button" class="btn btn-sm btn-outline-secondary active" data-cuatri="todos" onclick="filtrar('cuatrimestre', 'todos')">
                                    Todos
                                </button>
                                {% for i in range(0, 11) %}
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-cuatri="{{ i }}" onclick="filtrar('cuatrimestre', '{{ i }}')">
                                    {{ i }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Buscador -->
                        <div class="col border-start ps-3">
                            <label class="small text-muted d-block mb-1">Buscar:</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-start-0" id="buscar-materia" 
                                       placeholder="Código o nombre..." onkeyup="filtrar('texto')">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario Principal -->
            <form method="POST" action="" id="form-asignar-materias">
                {{ form.hidden_tag() }}
                
                <div id="materias-container" class="row">
                    <!-- Las materias se renderizarán aquí -->
                </div>
            </form>

        </div>
    </div>
</div>

<!-- Sticky Footer -->
<div class="fixed-bottom bg-white border-top shadow-lg py-3" style="z-index: 1030;">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                    <i class="fas fa-check"></i>
                </div>
                <div>
                    <h5 class="mb-0" id="footer-count">0</h5>
                    <small class="text-muted">Materias seleccionadas</small>
                </div>
            </div>
            
            <div>
                <button type="button" class="btn btn-outline-secondary me-2" onclick="seleccionarVisibles(true)">
                    <i class="fas fa-check-double me-1"></i>Seleccionar Visibles
                </button>
                <button type="button" class="btn btn-outline-danger me-2" onclick="seleccionarVisibles(false)">
                    <i class="fas fa-times me-1"></i>Ninguna
                </button>
                <button type="submit" form="form-asignar-materias" class="btn btn-primary px-4 fw-bold">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .carrera-section {
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .cuatri-block {
        background: #fff;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #e9ecef;
        overflow: hidden;
    }
    
    .cuatri-header {
        background: #f8f9fa;
        padding: 8px 15px;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .materia-item {
        padding: 8px 12px;
        border-bottom: 1px solid #f1f3f5;
        transition: background-color 0.15s ease;
        display: flex;
        align-items: center;
    }
    
    .materia-item:last-child {
        border-bottom: none;
    }
    
    .materia-item:hover {
        background-color: #f8f9fa;
    }
    
    .materia-label {
        font-size: 0.9rem;
        color: #212529;
        cursor: pointer;
        flex-grow: 1;
        margin-left: 8px;
    }
    
    .form-check-input:checked + .materia-label {
        font-weight: 600;
        color: #0d6efd;
    }
    
    .item-hidden {
        display: none !important;
    }

    /* Colores refinados para bordes de cuatrimestre */
    .border-carrera-0 { border-left: 4px solid #e74c3c; }
    .border-carrera-1 { border-left: 4px solid #3498db; }
    .border-carrera-2 { border-left: 4px solid #2ecc71; }
    .border-carrera-3 { border-left: 4px solid #f39c12; }
    .border-carrera-4 { border-left: 4px solid #9b59b6; }
</style>

<script>
// Data
// eslint-disable-next-line
const materiasDisponibles = {{ form.materias.choices | tojson }};
// eslint-disable-next-line
const materiasAsignadas = {{ form.materias.data | tojson }};
// eslint-disable-next-line
const carrerasProfesor = {{ profesor.carreras | map(attribute='codigo') | list | tojson }};

// State
let estadoFiltros = {
    carrera: 'todas',
    cuatrimestre: 'todos',
    texto: ''
};

const coloresCarrera = {};
carrerasProfesor.forEach((codigo, index) => {
    coloresCarrera[codigo] = index % 5;
});

document.addEventListener('DOMContentLoaded', function() {
    renderizarUI();
    actualizarFooter();
});

function renderizarUI() {
    const container = document.getElementById('materias-container');
    container.innerHTML = '';
    
    // 1. Organizar datos
    const estructura = {};
    
    materiasDisponibles.forEach(([id, texto]) => {
        const matchCarrera = texto.match(/\(([^)]+)\)$/);
        const matchCuatri = texto.match(/Cuatri (\d+)/);
        
        const carrera = matchCarrera ? matchCarrera[1] : 'Sin Carrera';
        const cuatrimestre = matchCuatri ? parseInt(matchCuatri[1]) : 0;
        
        if (!estructura[carrera]) estructura[carrera] = {};
        if (!estructura[carrera][cuatrimestre]) estructura[carrera][cuatrimestre] = [];
        
        // Limpiamos el texto para que sea más legible
        const nombreLimpio = texto.replace(/^Cuatri \d+ - /, '').replace(/\([^)]+\)$/, '').trim();
        
        estructura[carrera][cuatrimestre].push({
            id: id,
            nombre: nombreLimpio,
            textoCompleto: texto.toLowerCase(),
            checked: materiasAsignadas.includes(id)
        });
    });

    // 2. Construir HTML
    const carrerasOrdenadas = Object.keys(estructura).sort();
    
    carrerasOrdenadas.forEach((carrera) => {
        const colorIndex = coloresCarrera[carrera] !== undefined ? coloresCarrera[carrera] : 0;
        
        // Contenedor de Carrera
        const carreraDiv = document.createElement('div');
        carreraDiv.className = 'col-12 carrera-section';
        carreraDiv.setAttribute('data-carrera', carrera);
        
        // Título de Carrera
        carreraDiv.innerHTML = `
            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                <i class="fas fa-graduation-cap me-2" style="color: grey;"></i>
                <h5 class="mb-0 text-muted">${carrera}</h5>
            </div>
        `;
        
        const cuatrisContainer = document.createElement('div');
        cuatrisContainer.className = 'row'; // Grid para los cuatris
        
        const cuatrosOrdenados = Object.keys(estructura[carrera]).sort((a,b) => a-b);
        
        cuatrosOrdenados.forEach(cuatri => {
            const materias = estructura[carrera][cuatri];
            const colDiv = document.createElement('div');
            // Responsive: 1 columna en móvil, 2 en tablets, 3 en desktop grande
            colDiv.className = 'col-md-6 col-xl-4 cuatri-wrapper mb-3'; 
            colDiv.setAttribute('data-cuatri', cuatri);
            
            let materiasHTML = '';
            materias.forEach(m => {
                materiasHTML += `
                    <div class="materia-item" data-texto="${m.textoCompleto}">
                        <input class="form-check-input" type="checkbox" name="materias" 
                               value="${m.id}" id="m-${m.id}" 
                               ${m.checked ? 'checked' : ''} 
                               onchange="actualizarFooter()">
                        <label class="materia-label" for="m-${m.id}">
                            ${m.nombre}
                        </label>
                    </div>
                `;
            });
            
            colDiv.innerHTML = `
                <div class="cuatri-block border-carrera-${colorIndex} h-100 shadow-sm">
                    <div class="cuatri-header">
                        <span>Cuatrimestre ${cuatri}</span>
                        <span class="badge bg-light text-dark border">${materias.length}</span>
                    </div>
                    <div class="materias-list">
                        ${materiasHTML}
                    </div>
                </div>
            `;
            
            cuatrisContainer.appendChild(colDiv);
        });
        
        carreraDiv.appendChild(cuatrisContainer);
        container.appendChild(carreraDiv);
    });
}

function filtrar(tipo, valor) {
    // Actualizar estado
    if (tipo === 'carrera') estadoFiltros.carrera = valor;
    if (tipo === 'cuatrimestre') estadoFiltros.cuatrimestre = valor;
    if (tipo === 'texto') estadoFiltros.texto = document.getElementById('buscar-materia').value.toLowerCase();
    
    // Actualizar UI Botones
    if (tipo === 'carrera') {
        document.querySelectorAll('#filtro-carreras button').forEach(b => {
            b.classList.toggle('active', b.getAttribute('data-carrera') === valor);
        });
    }
    if (tipo === 'cuatrimestre') {
        document.querySelectorAll('#filtro-cuatris button').forEach(b => {
            b.classList.toggle('active', b.getAttribute('data-cuatri') === valor);
        });
    }
    
    // Aplicar filtros al DOM
    aplicarFiltrosDOM();
}

function aplicarFiltrosDOM() {
    // 1. Filtrar Secciones de Carrera
    document.querySelectorAll('.carrera-section').forEach(section => {
        const carrera = section.getAttribute('data-carrera');
        const visiblePorCarrera = (estadoFiltros.carrera === 'todas' || estadoFiltros.carrera === carrera);
        
        if (!visiblePorCarrera) {
            section.classList.add('item-hidden');
            return; // No necesitamos procesar los hijos si la carrera está oculta
        }
        
        // 2. Filtrar Bloques de Cuatrimestre dentro de la carrera visible
        let tieneCuatrisVisibles = false;
        
        section.querySelectorAll('.cuatri-wrapper').forEach(cuatriBlock => {
            const cuatri = cuatriBlock.getAttribute('data-cuatri');
            const visiblePorCuatri = (estadoFiltros.cuatrimestre === 'todos' || estadoFiltros.cuatrimestre === cuatri);
            
            if (!visiblePorCuatri) {
                cuatriBlock.classList.add('item-hidden');
                return;
            }
            
            // 3. Filtrar Materias por Texto dentro del cuatri visible
            let tieneMateriasVisibles = false;
            
            cuatriBlock.querySelectorAll('.materia-item').forEach(item => {
                const texto = item.getAttribute('data-texto');
                const visiblePorTexto = texto.includes(estadoFiltros.texto);
                
                if (visiblePorTexto) {
                    item.classList.remove('item-hidden');
                    tieneMateriasVisibles = true;
                } else {
                    item.classList.add('item-hidden');
                }
            });
            
            if (tieneMateriasVisibles) {
                cuatriBlock.classList.remove('item-hidden');
                tieneCuatrisVisibles = true;
            } else {
                cuatriBlock.classList.add('item-hidden');
            }
        });
        
        if (tieneCuatrisVisibles) {
            section.classList.remove('item-hidden');
        } else {
            section.classList.add('item-hidden');
        }
    });
}

function seleccionarVisibles(seleccionar) {
    // Solo selecciona los inputs que NO están ocultos por ningún filtro
    const inputs = document.querySelectorAll('input[name="materias"]');
    inputs.forEach(input => {
        // Verificar visibilidad revisando ancestros
        const item = input.closest('.materia-item');
        const cuatri = input.closest('.cuatri-wrapper');
        const carrera = input.closest('.carrera-section');
        
        if (!item.classList.contains('item-hidden') && 
            !cuatri.classList.contains('item-hidden') && 
            !carrera.classList.contains('item-hidden')) {
            input.checked = seleccionar;
        }
    });
    actualizarFooter();
}

function actualizarFooter() {
    const count = document.querySelectorAll('input[name="materias"]:checked').length;
    document.getElementById('footer-count').textContent = count;
}
</script>
{% endblock %}
