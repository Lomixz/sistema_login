{% extends "base.html" %}

{% block title %}Gestión de Usuarios - Administración{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-users me-2"></i>
                Gestión de Usuarios
            </h2>
            <div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary me-2">
                    <i class="fas fa-arrow-left me-1"></i>
                    Volver al Dashboard
                </a>
                <a href="{{ url_for('agregar_usuario') }}" class="btn btn-primary">
                    <i class="fas fa-user-plus me-1"></i>
                    Agregar Usuario
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Total Usuarios</h5>
                        <h3 class="mb-0">{{ total_usuarios }}</h3>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Usuarios Activos</h5>
                        <h3 class="mb-0">{{ usuarios_activos }}</h3>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Usuarios Inactivos</h5>
                        <h3 class="mb-0">{{ usuarios_inactivos }}</h3>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Roles Diferentes</h5>
                        <h3 class="mb-0">{{ roles_count|length }}</h3>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-tags fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    Filtros
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Búsqueda por texto -->
                    <div class="col-md-4">
                        <label for="busqueda-texto" class="form-label">
                            <i class="fas fa-search me-1"></i>Buscar
                        </label>
                        <input type="text" 
                               id="busqueda-texto" 
                               class="form-control" 
                               placeholder="Nombre, apellido, usuario o email...">
                    </div>
                    
                    <!-- Filtro por rol -->
                    <div class="col-md-3">
                        <label for="filtro-rol" class="form-label">
                            <i class="fas fa-user-tag me-1"></i>Rol
                        </label>
                        <select id="filtro-rol" class="form-select">
                            <option value="">Todos los roles</option>
                            <option value="Administrador">Administrador</option>
                            <option value="Jefe de Carrera">Jefe de Carrera</option>
                            <option value="Profesor">Profesores (Todos)</option>
                            <option value="Profesor Tiempo Completo">Profesor Tiempo Completo</option>
                            <option value="Profesor por Asignatura">Profesor por Asignatura</option>
                        </select>
                    </div>
                    
                    <!-- Filtro por estado -->
                    <div class="col-md-3">
                        <label for="filtro-estado" class="form-label">
                            <i class="fas fa-toggle-on me-1"></i>Estado
                        </label>
                        <select id="filtro-estado" class="form-select">
                            <option value="">Todos los estados</option>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                    
                    <!-- Botón limpiar -->
                    <div class="col-md-2 d-flex align-items-end">
                        <button id="limpiar-filtros" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-times me-1"></i>
                            Limpiar
                        </button>
                    </div>
                </div>
                
                <!-- Contador de resultados -->
                <div class="mt-3">
                    <span id="contador-resultados" class="badge bg-primary">
                        Mostrando <span id="total-visible">{{ usuarios|length }}</span> de {{ usuarios|length }} usuarios
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Usuarios -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Lista de Usuarios
                </h5>
            </div>
            <div class="card-body">
                {% if usuarios %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Usuario</th>
                                    <th>Nombre Completo</th>
                                    <th>Email</th>
                                    <th class="text-center">Rol</th>
                                    <th>Carrera</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Registro</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usuario in usuarios %}
                                <tr class="fila-usuario"
                                    data-nombre="{{ usuario.get_nombre_completo()|lower }}"
                                    data-username="{{ usuario.username|lower }}"
                                    data-email="{{ usuario.email|lower }}"
                                    data-rol="{{ usuario.get_rol_display() }}"
                                    data-estado="{{ 'Activo' if usuario.activo else 'Inactivo' }}">
                                    <td>{{ usuario.username }}</td>
                                    <td>{{ usuario.get_nombre_completo() }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-{% if usuario.rol == 'admin' %}danger{% elif usuario.rol == 'jefe_carrera' %}warning{% else %}primary{% endif %}">
                                            {{ usuario.get_rol_display() }}
                                        </span>
                                    </td>
                                    <td>{{ usuario.get_carrera_nombre() }}</td>
                                    <td class="text-center">
                                        {% if usuario.activo %}
                                            <span class="badge bg-success">Activo</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ usuario.fecha_registro.strftime('%d/%m/%Y') }}</td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('editar_usuario', id=usuario.id) }}" 
                                               class="btn btn-sm btn-outline-primary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Editar Usuario">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{{ url_for('cambiar_password_usuario', id=usuario.id) }}" 
                                               class="btn btn-sm btn-outline-secondary" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-placement="top" 
                                               title="Cambiar Contraseña">
                                                <i class="fas fa-key"></i>
                                            </a>
                                            {% if usuario.activo %}
                                                <form method="POST" action="{{ url_for('desactivar_usuario', id=usuario.id) }}" style="display: inline;">
                                                    <button type="submit" 
                                                            class="btn btn-sm btn-outline-warning" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-placement="top" 
                                                            title="Desactivar Usuario"
                                                            onclick="return confirm('¿Estás seguro de desactivar este usuario?')">
                                                        <i class="fas fa-ban"></i>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <form method="POST" action="{{ url_for('activar_usuario', id=usuario.id) }}" style="display: inline;">
                                                    <button type="submit" 
                                                            class="btn btn-sm btn-outline-success" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-placement="top" 
                                                            title="Activar Usuario"
                                                            onclick="return confirm('¿Estás seguro de activar este usuario?')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </form>
                                            {% endif %}
                                            {% if usuario.id != current_user.id %}
                                                <a href="{{ url_for('eliminar_usuario', id=usuario.id) }}" 
                                                   class="btn btn-sm btn-outline-danger" 
                                                   data-bs-toggle="tooltip" 
                                                   data-bs-placement="top" 
                                                   title="Eliminar Usuario">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info text-center">
                        <h4>No se encontraron usuarios</h4>
                        <p>No hay usuarios que coincidan con los criterios de búsqueda.</p>
                        <a href="{{ url_for('gestionar_usuarios') }}" class="btn btn-primary">
                            <i class="fas fa-times me-1"></i>
                            Limpiar Filtros
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const busquedaTexto = document.getElementById('busqueda-texto');
    const filtroRol = document.getElementById('filtro-rol');
    const filtroEstado = document.getElementById('filtro-estado');
    const limpiarBtn = document.getElementById('limpiar-filtros');
    const totalUsuarios = {{ usuarios|length }};
    
    // Event listeners para filtros
    busquedaTexto.addEventListener('input', filtrarTabla);
    filtroRol.addEventListener('change', filtrarTabla);
    filtroEstado.addEventListener('change', filtrarTabla);
    
    // Limpiar filtros
    limpiarBtn.addEventListener('click', function() {
        busquedaTexto.value = '';
        filtroRol.value = '';
        filtroEstado.value = '';
        filtrarTabla();
    });
    
    function filtrarTabla() {
        const textoBusqueda = busquedaTexto.value.toLowerCase().trim();
        const rolSeleccionado = filtroRol.value;
        const estadoSeleccionado = filtroEstado.value;
        
        const filas = document.querySelectorAll('.fila-usuario');
        let totalVisible = 0;
        
        filas.forEach(fila => {
            const nombre = fila.dataset.nombre;
            const username = fila.dataset.username;
            const email = fila.dataset.email;
            const rol = fila.dataset.rol;
            const estado = fila.dataset.estado;
            
            // Verificar si coincide con búsqueda de texto
            const coincideTexto = !textoBusqueda || 
                                  nombre.includes(textoBusqueda) || 
                                  username.includes(textoBusqueda) || 
                                  email.includes(textoBusqueda);
            
            // Verificar si coincide con rol
            let coincideRol = !rolSeleccionado;
            if (rolSeleccionado) {
                if (rolSeleccionado === 'Profesor') {
                    // Si se selecciona "Profesor", mostrar ambos tipos
                    coincideRol = rol.includes('Profesor');
                } else {
                    coincideRol = rol === rolSeleccionado;
                }
            }
            
            // Verificar si coincide con estado
            const coincideEstado = !estadoSeleccionado || estado === estadoSeleccionado;
            
            // Mostrar/ocultar fila
            if (coincideTexto && coincideRol && coincideEstado) {
                fila.style.display = '';
                totalVisible++;
            } else {
                fila.style.display = 'none';
            }
        });
        
        // Actualizar contador
        actualizarContador(totalVisible, totalUsuarios);
        
        // Mostrar mensaje si no hay resultados
        mostrarMensajeSinResultados(totalVisible);
    }
    
    function actualizarContador(visible, total) {
        const contadorElement = document.getElementById('total-visible');
        contadorElement.textContent = visible;
        
        // Cambiar color del badge según los resultados
        const badge = document.getElementById('contador-resultados');
        if (visible === 0) {
            badge.className = 'badge bg-danger';
        } else if (visible < total) {
            badge.className = 'badge bg-warning';
        } else {
            badge.className = 'badge bg-primary';
        }
    }
    
    function mostrarMensajeSinResultados(totalVisible) {
        // Buscar si ya existe el mensaje
        let mensajeExistente = document.getElementById('mensaje-sin-resultados');
        
        if (totalVisible === 0) {
            if (!mensajeExistente) {
                // Crear mensaje de sin resultados
                const tbody = document.querySelector('tbody');
                const mensaje = document.createElement('tr');
                mensaje.id = 'mensaje-sin-resultados';
                mensaje.innerHTML = `
                    <td colspan="8" class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="lead text-muted">No se encontraron usuarios con los filtros aplicados</p>
                        <button class="btn btn-outline-primary" onclick="document.getElementById('limpiar-filtros').click()">
                            <i class="fas fa-undo me-1"></i>Limpiar Filtros
                        </button>
                    </td>
                `;
                tbody.appendChild(mensaje);
            }
        } else {
            // Eliminar mensaje si existe
            if (mensajeExistente) {
                mensajeExistente.remove();
            }
        }
    }
});

// Inicializar tooltips de Bootstrap
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<style>
/* Evitar recorte de botones en la tabla de usuarios */
.card-body .table-responsive {
    overflow-x: auto !important;
    overflow-y: visible !important;
    overflow: visible !important;
    border-radius: 0 !important;
}

/* Desactivar el escalado en hover que causa recortes */
.table tbody tr:hover {
    transform: none !important;
    box-shadow: none !important;
}

/* Asegurar que la columna de acciones tenga suficiente espacio */
.table thead th:last-child,
.table tbody td:last-child {
    white-space: nowrap;
    min-width: 200px;
    width: 200px;
    padding-right: 1.5rem !important;
    padding-left: 1rem !important;
}

/* Asegurar que los btn-group no se envuelvan y sean visibles */
.table .btn-group {
    display: inline-flex !important;
    flex-wrap: nowrap !important;
    gap: 2px;
}

/* Ajustar tamaño de botones */
.table .btn-group .btn-sm {
    padding: 0.35rem 0.6rem !important;
    font-size: 0.875rem;
}

/* Forzar visibilidad de tooltips */
.table tbody tr {
    position: relative;
    z-index: 1;
}

.table tbody tr:hover {
    z-index: 2;
    position: relative;
}
</style>
{% endblock %}