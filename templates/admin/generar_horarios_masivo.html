{% extends "base.html" %}

{% block title %}Generaci√≥n Masiva de Horarios{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-rocket me-2"></i>
                        Generaci√≥n Masiva de Horarios
                    </h1>
                    <p class="text-muted mt-1">
                        <i class="fas fa-balance-scale me-1"></i>
                        Genera horarios para m√∫ltiples grupos simult√°neamente - <strong>Todos los grupos equilibrados</strong>
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('generar_horarios_academicos') }}" class="btn btn-outline-info me-2">
                        <i class="fas fa-user me-1"></i>
                        Generar Individual
                    </a>
                    <a href="{{ url_for('gestionar_horarios_academicos') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>
                        Regresar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerta informativa -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h5 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>
                    ¬øPor qu√© generaci√≥n masiva?
                </h5>
                <p class="mb-2"><strong>Ventajas:</strong></p>
                <ul class="mb-0">
                    <li><strong>Equidad total:</strong> Todos los grupos compiten por los mejores horarios simult√°neamente</li>
                    <li><strong>Sin privilegios:</strong> No hay grupos "primeros" con buenos horarios y "√∫ltimos" con horarios feos</li>
                    <li><strong>Optimizaci√≥n global:</strong> Mejor distribuci√≥n de profesores y recursos</li>
                    <li><strong>Calidad homog√©nea:</strong> Todos los estudiantes tienen horarios de calidad similar</li>
                </ul>
            </div>
        </div>
    </div>

    <form method="POST" id="form-generar-masivo">
        <div class="row">
            <!-- Panel de selecci√≥n de grupos -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>
                            Seleccionar Grupos
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if grupos_organizados %}
                            <div class="mb-3">
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="seleccionarTodos()">
                                    <i class="fas fa-check-double me-1"></i>
                                    Seleccionar Todos
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodos()">
                                    <i class="fas fa-times me-1"></i>
                                    Deseleccionar Todos
                                </button>
                            </div>

                            {% for carrera, cuatrimestres in grupos_organizados.items() %}
                                <div class="mb-4">
                                    <h6 class="text-primary border-bottom pb-2">
                                        <i class="fas fa-graduation-cap me-2"></i>
                                        {{ carrera }}
                                    </h6>
                                    
                                    {% for cuatri, grupos in cuatrimestres.items() %}
                                        <div class="ms-3 mb-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <strong class="me-2">Cuatrimestre {{ cuatri }}:</strong>
                                                <button type="button" class="btn btn-sm btn-link" 
                                                        onclick="toggleCuatrimestre('{{ carrera|replace(' ', '_') }}_{{ cuatri }}')">
                                                    <i class="fas fa-check-square me-1"></i>
                                                    Seleccionar todos
                                                </button>
                                            </div>
                                            
                                            <div class="row g-2">
                                                {% for grupo in grupos %}
                                                    <div class="col-md-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input grupo-checkbox cuatri-{{ carrera|replace(' ', '_') }}_{{ cuatri }}" 
                                                                   type="checkbox" 
                                                                   name="grupos_ids[]" 
                                                                   value="{{ grupo.id }}" 
                                                                   id="grupo_{{ grupo.id }}"
                                                                   onchange="actualizarContador()">
                                                            <label class="form-check-label" for="grupo_{{ grupo.id }}">
                                                                <strong>{{ grupo.codigo }}</strong>
                                                                <small class="text-muted">
                                                                    - {{ grupo.get_turno_display() }}
                                                                    ({{ grupo.materias|length }} materias)
                                                                </small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                No hay grupos activos disponibles para generar horarios.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Panel de configuraci√≥n -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Configuraci√≥n
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Contador de grupos seleccionados -->
                        <div class="alert alert-light border text-center mb-3">
                            <h3 class="mb-1" id="grupos-contador">0</h3>
                            <small class="text-muted">grupos seleccionados</small>
                        </div>

                        <!-- Nombre de versi√≥n -->
                        <div class="mb-3">
                            <label for="version_nombre" class="form-label">
                                <i class="fas fa-tag me-1"></i>
                                Nombre de Versi√≥n
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="version_nombre" 
                                   name="version_nombre"
                                   placeholder="Ej: Final Cuatri 3">
                            <small class="text-muted">Opcional. Se genera autom√°ticamente si se deja vac√≠o.</small>
                        </div>

                        <!-- D√≠as de la semana -->
                        <div class="mb-3">
                            <label for="dias_semana" class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i>
                                D√≠as de la Semana
                            </label>
                            <select class="form-select" id="dias_semana" name="dias_semana">
                                <option value="lunes_viernes">Lunes a Viernes</option>
                                <option value="lunes_sabado">Lunes a S√°bado</option>
                            </select>
                        </div>

                        <!-- Tiempo estimado -->
                        <div class="alert alert-warning mb-3">
                            <small>
                                <i class="fas fa-clock me-1"></i>
                                <strong>Tiempo estimado:</strong><br>
                                <span id="tiempo-estimado">Selecciona grupos</span>
                            </small>
                        </div>

                        <!-- Bot√≥n de generar -->
                        <button type="submit" 
                                class="btn btn-success w-100" 
                                id="btn-generar"
                                disabled>
                            <i class="fas fa-rocket me-2"></i>
                            Generar Horarios Masivos
                        </button>

                        <small class="text-muted mt-2 d-block text-center">
                            <i class="fas fa-shield-alt me-1"></i>
                            Los horarios anteriores se desactivar√°n
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Resultados -->
    {% if resultado %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-{{ 'success' if resultado.exito else 'danger' }}">
                    <div class="card-header bg-{{ 'success' if resultado.exito else 'danger' }} text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-{{ 'check-circle' if resultado.exito else 'exclamation-circle' }} me-2"></i>
                            Resultados de la Generaci√≥n Masiva
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">{{ resultado.mensaje }}</p>
                        
                        {% if resultado.exito %}
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0">{{ resultado.grupos_procesados }}</h3>
                                            <small class="text-muted">Grupos Procesados</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0">{{ resultado.horarios_generados }}</h3>
                                            <small class="text-muted">Horarios Creados</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="mb-0">{{ resultado.algoritmo }}</h6>
                                            <small class="text-muted">Algoritmo Utilizado</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 text-center">
                                <a href="{{ url_for('gestionar_horarios_academicos') }}" class="btn btn-primary">
                                    <i class="fas fa-eye me-1"></i>
                                    Ver Horarios Generados
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
function seleccionarTodos() {
    document.querySelectorAll('.grupo-checkbox').forEach(cb => cb.checked = true);
    actualizarContador();
}

function deseleccionarTodos() {
    document.querySelectorAll('.grupo-checkbox').forEach(cb => cb.checked = false);
    actualizarContador();
}

function toggleCuatrimestre(clase) {
    const checkboxes = document.querySelectorAll('.cuatri-' + clase);
    const algunoMarcado = Array.from(checkboxes).some(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !algunoMarcado);
    actualizarContador();
}

function actualizarContador() {
    const seleccionados = document.querySelectorAll('.grupo-checkbox:checked').length;
    document.getElementById('grupos-contador').textContent = seleccionados;
    
    const btnGenerar = document.getElementById('btn-generar');
    btnGenerar.disabled = seleccionados === 0;
    
    // Calcular tiempo estimado
    let tiempo = '';
    if (seleccionados === 0) {
        tiempo = 'Selecciona grupos';
    } else if (seleccionados === 1) {
        tiempo = '1-3 minutos';
    } else if (seleccionados <= 3) {
        tiempo = '3-5 minutos';
    } else if (seleccionados <= 5) {
        tiempo = '5-8 minutos';
    } else {
        tiempo = '8-10 minutos';
    }
    document.getElementById('tiempo-estimado').textContent = tiempo;
}

// Confirmar antes de enviar
document.getElementById('form-generar-masivo').addEventListener('submit', function(e) {
    const seleccionados = document.querySelectorAll('.grupo-checkbox:checked').length;
    
    if (seleccionados === 0) {
        e.preventDefault();
        alert('‚ùå Debe seleccionar al menos un grupo');
        return false;
    }
    
    const confirmacion = confirm(
        `üöÄ ¬øGenerar horarios para ${seleccionados} grupo(s)?\n\n` +
        `‚úì Todos los grupos se generar√°n simult√°neamente\n` +
        `‚úì Los horarios se optimizar√°n de forma equilibrada\n` +
        `‚ö†Ô∏è  Los horarios anteriores se desactivar√°n\n\n` +
        `Este proceso puede tomar varios minutos.`
    );
    
    if (!confirmacion) {
        e.preventDefault();
        return false;
    }
    
    // Mostrar loading
    const btnGenerar = document.getElementById('btn-generar');
    btnGenerar.disabled = true;
    btnGenerar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando... Por favor espere';
});

// Inicializar contador
actualizarContador();
</script>
{% endblock %}
