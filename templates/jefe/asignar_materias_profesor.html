{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-book-open me-2 text-primary"></i>{{ titulo }}</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('gestionar_profesores_jefe') }}">Profesores</a></li>
                            <li class="breadcrumb-item active">Asignar Materias</li>
                        </ol>
                    </nav>
                </div>
                <a href="{{ url_for('gestionar_profesores_jefe') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver
                </a>
            </div>

            <!-- Informaci贸n del Profesor - Card Mejorada -->
            <div class="card mb-4 border-0 shadow">
                <div class="card-body bg-gradient-primary text-white rounded" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="row align-items-center">
                        <div class="col-md-1 text-center">
                            <div class="avatar-circle bg-white text-primary">
                                <i class="fas fa-user-tie fa-2x"></i>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <h4 class="mb-1 fw-bold">{{ profesor.get_nombre_completo() }}</h4>
                            <p class="mb-1 opacity-75">
                                <i class="fas fa-envelope me-2"></i>{{ profesor.email }}
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-white text-primary me-2">{{ profesor.get_rol_display() }}</span>
                                {% for carrera in profesor.carreras %}
                                <span class="badge bg-light bg-opacity-25">{{ carrera.codigo }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-inline-block text-center p-3 bg-white bg-opacity-25 rounded-3">
                                <h2 class="mb-0 fw-bold" id="materias-count">{{ profesor.materias|length }}</h2>
                                <small>Materias Asignadas</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario de Asignaci贸n -->
            <div class="card border-0 shadow">
                <div class="card-header bg-white border-bottom py-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0">
                            <i class="fas fa-clipboard-list me-2 text-primary"></i>
                            Seleccionar Materias
                        </h5>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success btn-sm" onclick="seleccionarTodas()">
                                <i class="fas fa-check-double me-1"></i>Seleccionar Todas
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deseleccionarTodas()">
                                <i class="fas fa-times me-1"></i>Deseleccionar Todas
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Buscador Mejorado -->
                    <div class="mb-4">
                        <div class="input-group input-group-lg shadow-sm">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fas fa-search text-primary"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" id="buscar-materia" 
                                   placeholder=" Buscar por c贸digo o nombre de materia...">
                        </div>
                    </div>

                    <form method="POST" action="" id="form-asignar-materias">
                        {{ form.hidden_tag() }}
                        
                        <div id="materias-container">
                            <!-- Las materias se renderizan aqu铆 por JavaScript -->
                        </div>

                        <!-- Botones de Acci贸n -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
                            <a href="{{ url_for('gestionar_profesores_jefe') }}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg shadow">
                                <i class="fas fa-save me-2"></i>Guardar Asignaciones
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Resumen de Materias Seleccionadas -->
            <div class="card mt-4 border-0 shadow">
                <div class="card-header bg-success text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Resumen de Selecci贸n
                        </h5>
                        <span class="badge bg-white text-success fs-5" id="total-seleccionadas">0</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="resumen-seleccionadas">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-inbox fa-2x mb-2 opacity-50"></i>
                            <p class="mb-0">No hay materias seleccionadas</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .avatar-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .cuatrimestre-card {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .cuatrimestre-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .cuatrimestre-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1.25rem;
        cursor: pointer;
    }
    
    .materias-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 0.75rem;
        padding: 1.25rem;
    }
    
    .materia-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        border-left: 4px solid #667eea;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
    }
    
    .materia-item:hover {
        background: #e9ecef;
        transform: translateX(3px);
    }
    
    .materia-item.selected {
        background: #d4edda;
        border-left-color: #28a745;
    }
    
    .materia-item .form-check-input {
        width: 1.25em;
        height: 1.25em;
        margin-right: 0.75rem;
        cursor: pointer;
    }
    
    .materia-item .form-check-input:checked {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .materia-item label {
        cursor: pointer;
        margin-bottom: 0;
        font-size: 0.9rem;
    }
    
    .materia-item .materia-codigo {
        font-weight: 600;
        color: #667eea;
    }
    
    .materia-item .materia-nombre {
        color: #495057;
    }
    
    .materia-hidden {
        display: none !important;
    }
    
    .resumen-materia {
        display: inline-block;
        background: #e9ecef;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        margin: 0.25rem;
    }
    
    .resumen-materia i {
        color: #28a745;
    }
    
    @media (max-width: 768px) {
        .materias-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
// Datos de materias desde el servidor
const materiasDisponibles = {{ form.materias.choices | tojson }};
const materiasAsignadas = {{ form.materias.data | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    renderizarMaterias();
    actualizarResumen();
    
    // Configurar buscador con debounce
    let timeout;
    document.getElementById('buscar-materia').addEventListener('input', function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => filtrarMaterias(this.value), 200);
    });
});

function renderizarMaterias() {
    const container = document.getElementById('materias-container');
    const materiasPorCuatrimestre = {};
    
    // Agrupar materias por cuatrimestre
    materiasDisponibles.forEach(([id, texto]) => {
        const match = texto.match(/Cuatri (\d+)/);
        const cuatrimestre = match ? match[1] : '0';
        if (!materiasPorCuatrimestre[cuatrimestre]) {
            materiasPorCuatrimestre[cuatrimestre] = [];
        }
        materiasPorCuatrimestre[cuatrimestre].push([id, texto]);
    });
    
    // Renderizar por cuatrimestre con nuevo dise帽o
    Object.keys(materiasPorCuatrimestre).sort((a, b) => parseInt(a) - parseInt(b)).forEach(cuatrimestre => {
        const card = document.createElement('div');
        card.className = 'cuatrimestre-card';
        
        const cantidadMaterias = materiasPorCuatrimestre[cuatrimestre].length;
        
        card.innerHTML = `
            <div class="cuatrimestre-header d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>
                        Cuatrimestre ${cuatrimestre}
                        <span class="badge bg-white text-primary ms-2">${cantidadMaterias} materias</span>
                    </h6>
                </div>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-light btn-sm" onclick="toggleCuatrimestre('${cuatrimestre}', true)">
                        <i class="fas fa-check-square"></i> Todas
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="toggleCuatrimestre('${cuatrimestre}', false)">
                        <i class="fas fa-square"></i> Ninguna
                    </button>
                </div>
            </div>
            <div class="materias-grid" id="materias-cuatri-${cuatrimestre}"></div>
        `;
        
        container.appendChild(card);
        
        const materiasGrid = document.getElementById(`materias-cuatri-${cuatrimestre}`);
        
        materiasPorCuatrimestre[cuatrimestre].forEach(([id, texto]) => {
            const isChecked = materiasAsignadas.includes(id);
            // Extraer c贸digo y nombre
            const partes = texto.split(':');
            const codigo = partes[0].replace(/Cuatri \d+ - /, '').trim();
            const nombre = partes.length > 1 ? partes[1].trim() : codigo;
            
            const materiaDiv = document.createElement('div');
            materiaDiv.className = `materia-item ${isChecked ? 'selected' : ''}`;
            materiaDiv.setAttribute('data-cuatrimestre', cuatrimestre);
            materiaDiv.setAttribute('data-texto', texto.toLowerCase());
            materiaDiv.innerHTML = `
                <input class="form-check-input" type="checkbox" name="materias" value="${id}" 
                       id="materia-${id}" ${isChecked ? 'checked' : ''} 
                       onchange="toggleMateriaStyle(this); actualizarResumen()">
                <label class="form-check-label flex-grow-1" for="materia-${id}">
                    <span class="materia-codigo">${codigo}</span>: 
                    <span class="materia-nombre">${nombre}</span>
                </label>
            `;
            materiasGrid.appendChild(materiaDiv);
        });
    });
}

function toggleMateriaStyle(checkbox) {
    const item = checkbox.closest('.materia-item');
    if (checkbox.checked) {
        item.classList.add('selected');
    } else {
        item.classList.remove('selected');
    }
}

function toggleCuatrimestre(cuatrimestre, seleccionar) {
    const checkboxes = document.querySelectorAll(`[data-cuatrimestre="${cuatrimestre}"] input[type="checkbox"]`);
    checkboxes.forEach(cb => {
        if (!cb.closest('.materia-hidden')) {
            cb.checked = seleccionar;
            toggleMateriaStyle(cb);
        }
    });
    actualizarResumen();
}

function seleccionarTodas() {
    document.querySelectorAll('input[name="materias"]').forEach(cb => {
        if (!cb.closest('.materia-hidden')) {
            cb.checked = true;
            toggleMateriaStyle(cb);
        }
    });
    actualizarResumen();
}

function deseleccionarTodas() {
    document.querySelectorAll('input[name="materias"]').forEach(cb => {
        cb.checked = false;
        toggleMateriaStyle(cb);
    });
    actualizarResumen();
}

function filtrarMaterias(termino) {
    termino = termino.toLowerCase();
    const materias = document.querySelectorAll('.materia-item');
    
    materias.forEach(materia => {
        const texto = materia.getAttribute('data-texto');
        if (texto.includes(termino)) {
            materia.classList.remove('materia-hidden');
        } else {
            materia.classList.add('materia-hidden');
        }
    });
}

function actualizarResumen() {
    const seleccionadas = document.querySelectorAll('input[name="materias"]:checked');
    const total = seleccionadas.length;
    
    document.getElementById('total-seleccionadas').textContent = total;
    document.getElementById('materias-count').textContent = total;
    
    const resumenDiv = document.getElementById('resumen-seleccionadas');
    
    if (total === 0) {
        resumenDiv.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-inbox fa-2x mb-2 opacity-50"></i>
                <p class="mb-0">No hay materias seleccionadas</p>
            </div>
        `;
        return;
    }
    
    // Agrupar por cuatrimestre
    const porCuatrimestre = {};
    seleccionadas.forEach(cb => {
        const cuatrimestre = cb.closest('[data-cuatrimestre]').getAttribute('data-cuatrimestre');
        const label = cb.nextElementSibling;
        const codigo = label.querySelector('.materia-codigo').textContent;
        const nombre = label.querySelector('.materia-nombre').textContent;
        if (!porCuatrimestre[cuatrimestre]) {
            porCuatrimestre[cuatrimestre] = [];
        }
        porCuatrimestre[cuatrimestre].push({ codigo, nombre });
    });
    
    let html = '<div class="row">';
    Object.keys(porCuatrimestre).sort((a, b) => parseInt(a) - parseInt(b)).forEach(cuatri => {
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 border-success">
                    <div class="card-header bg-success bg-opacity-10 py-2">
                        <h6 class="mb-0 text-success">
                            <i class="fas fa-layer-group me-2"></i>
                            Cuatrimestre ${cuatri}
                            <span class="badge bg-success float-end">${porCuatrimestre[cuatri].length}</span>
                        </h6>
                    </div>
                    <div class="card-body py-2">
                        ${porCuatrimestre[cuatri].map(m => `
                            <span class="resumen-materia">
                                <i class="fas fa-check-circle me-1"></i>${m.codigo}
                            </span>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    resumenDiv.innerHTML = html;
}
</script>

{% endblock %}
