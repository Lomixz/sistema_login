{% extends "base.html" %}

{% block title %}Asignaci칩n Masiva de Materias{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Encabezado Gradient -->
    <div class="card border-0 shadow-sm mb-4 overflow-hidden">
        <div class="card-header py-4 position-relative" style="background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);">
            <div class="d-flex justify-content-between align-items-center position-relative" style="z-index: 2;">
                <div class="text-white">
                    <h3 class="mb-1 text-white">
                        <i class="fas fa-tasks me-2"></i> Asignaci칩n Masiva
                    </h3>
                    <p class="mb-0 opacity-75">
                        <i class="fas fa-graduation-cap me-2"></i>
                        Gestionando asignaciones para: <strong>{{ carrera.nombre }}</strong>
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-light text-primary fw-bold shadow-sm">
                        <i class="fas fa-arrow-left me-1"></i> Volver al Panel
                    </a>
                </div>
            </div>
            <!-- Shapes decorativos -->
            <div class="position-absolute bottom-0 end-0 opacity-10 me-5 mb-n5" style="transform: rotate(15deg);">
               <i class="fas fa-th fa-10x text-white"></i>
            </div>
        </div>
    </div>

    <!-- Filtros y Herramientas -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body bg-light rounded">
            <form method="GET" action="{{ url_for('asignacion_masiva_materias_jefe') }}" id="filtrosForm" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label text-muted small fw-bold">CUATRIMESTRE</label>
                    <select name="cuatrimestre" id="cuatrimestre" class="form-select border-0 shadow-sm" onchange="this.form.submit()">
                        <option value="">Todos los cuatrimestres</option>
                        {% for i in range(1, 13) %}
                        <option value="{{ i }}" {% if filtro_cuatrimestre == i %}selected{% endif %}>
                            Cuatrimestre {{ i }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <div class="form-check form-switch pt-3">
                         <input class="form-check-input" type="checkbox" name="solo_disponibles" value="1" 
                                id="soloDisponibles" {% if solo_disponibles %}checked{% endif %} onchange="this.form.submit()">
                         <label class="form-check-label" for="soloDisponibles">Solo con disponibilidad</label>
                    </div>
                 </div>
                <div class="col-md-4 text-end">
                    <button type="button" class="btn btn-outline-info btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#ayudaModal">
                        <i class="fas fa-question-circle"></i> Ayuda
                    </button>
                    {% if filtro_cuatrimestre %}
                    <a href="{{ url_for('asignacion_masiva_materias_jefe') }}" class="btn btn-link btn-sm text-muted text-decoration-none">
                        Limpiar filtros
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-primary">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                        <i class="fas fa-chalkboard-teacher text-primary fa-lg"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold text-dark">{{ profesores|length }}</h4>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Profesores</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-success">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
                        <i class="fas fa-book text-success fa-lg"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold text-dark">{{ materias|length }}</h4>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Materias</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-info">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-info bg-opacity-10 p-3 rounded-circle me-3">
                        <i class="fas fa-user-check text-info fa-lg"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold text-dark" id="contadorCambios">0</h4>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Cambios</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-warning">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle me-3">
                        <i class="fas fa-link text-warning fa-lg"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold text-dark">{{ asignaciones_actuales.values() | map('length') | sum }}</h4>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Total Asignado</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if profesores and materias %}
    <form method="POST" action="{{ url_for('asignacion_masiva_materias_jefe', cuatrimestre=filtro_cuatrimestre if filtro_cuatrimestre else '') }}" id="formAsignacion">
        <div class="card border-0 shadow-sm">
            
            <!-- Barra de Acciones de la Matriz -->
            <div class="card-header bg-white py-3 border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-dark fw-bold">
                        <i class="fas fa-th me-2 text-secondary"></i>Matriz de Asignaciones
                    </h5>
                    <div class="d-flex gap-2">
                        <div class="btn-group shadow-sm">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="seleccionarTodas()" title="Seleccionar Todo">
                                <i class="fas fa-check-double"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limpiarSeleccion()" title="Limpiar">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm shadow-sm px-4 fw-bold" id="btnGuardar">
                            <i class="fas fa-save me-1"></i> GUARDAR CAMBIOS
                        </button>
                    </div>
                </div>
            </div>

            <!-- Matriz -->
            <div class="card-body p-0">
                <div class="table-responsive bg-white" style="max-height: 70vh; overflow: auto;">
                    <table class="table table-hover table-bordered mb-0">
                        <thead class="bg-dark text-white shadow-sm" style="position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th class="p-3 border-0 bg-dark" style="position: sticky; left: 0; z-index: 11; min-width: 300px; width: 300px;">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="text-uppercase small fw-bold tracking-wider">Profesor</span>
                                        <i class="fas fa-check cursor-pointer opacity-50 hover-opacity-100" onclick="seleccionarColumna(-1)"></i>
                                    </div>
                                </th>
                                {% for materia in materias %}
                                <th class="text-center p-2 border-secondary align-middle bg-dark" style="min-width: 140px;">
                                    <div class="d-flex flex-column align-items-center cursor-pointer group-hover-target" onclick="seleccionarColumna({{ loop.index0 }})">
                                        <span class="badge bg-secondary mb-1" style="font-size: 0.7rem;">C{{ materia.cuatrimestre }}</span>
                                        <small class="d-block lh-sm text-truncate w-100" title="{{ materia.nombre }}" style="font-size: 0.75rem;">
                                            {{ materia.codigo }}<br>
                                            {{ materia.nombre }}
                                        </small>
                                        <i class="fas fa-caret-down mt-1 opacity-25 group-hover-visible"></i>
                                    </div>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for profesor in profesores %}
                            {% set carga = cargas_profesores[profesor.id] %}
                            <tr class="align-middle">
                                <!-- Columna Sticky Profesor -->
                                <th class="bg-white p-3 border-end" style="position: sticky; left: 0; z-index: 5;">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3 position-relative">
                                            {% if profesor.imagen_perfil %}
                                                <img src="{{ url_for('static', filename='uploads/perfiles/' + profesor.imagen_perfil) }}" class="rounded-circle" width="40" height="40">
                                            {% else %}
                                                <div class="avatar-circle-sm bg-light text-primary fw-bold">{{ profesor.nombre[0] }}{{ profesor.apellido[0] }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1" style="overflow: hidden;">
                                            <div class="d-flex justify-content-between align-items-center cursor-pointer" onclick="seleccionarFila({{ profesor.id }})">
                                                <h6 class="mb-0 text-truncate text-dark" title="{{ profesor.get_nombre_completo() }}">
                                                    {{ profesor.nombre }} {{ profesor.apellido }}
                                                </h6>
                                            </div>
                                            <div class="mt-1">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <small class="text-muted" style="font-size: 0.7rem;">
                                                        {{ profesor.get_tipo_profesor_display() }}
                                                    </small>
                                                    <span class="badge bg-{{ carga.color }}" style="font-size: 0.65rem; padding: 0.25em 0.4em;">
                                                        {{ carga.total_horas }}h / {{ carga.limite_maximo }}h
                                                    </span>
                                                </div>
                                                <div class="progress" style="height: 4px;">
                                                    <div class="progress-bar bg-{{ carga.color }}" role="progressbar" 
                                                         style="width: {{ carga.porcentaje }}%" 
                                                         aria-valuenow="{{ carga.porcentaje }}" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                
                                <!-- Celdas de Materias -->
                                {% for materia in materias %}
                                <td class="text-center p-0 position-relative cell-hover">
                                    {% set esta_asignada = materia.id in asignaciones_actuales.get(profesor.id, []) %}
                                    <label class="d-flex align-items-center justify-content-center w-100 h-100 py-3 cursor-pointer {{ 'bg-primary bg-opacity-10' if esta_asignada else '' }}">
                                        <input type="checkbox" 
                                               class="form-check-input assignment-check border-2" 
                                               style="width: 1.25em; height: 1.25em;"
                                               name="asignaciones[]" 
                                               value="{{ profesor.id }}-{{ materia.id }}"
                                               data-profesor="{{ profesor.id }}"
                                               data-materia="{{ materia.id }}"
                                               data-columna="{{ loop.index0 }}"
                                               onchange="actualizarContador(this)"
                                               {% if esta_asignada %}checked{% endif %}>
                                    </label>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card-footer bg-light py-3">
                 <div class="d-flex justify-content-between align-items-center text-muted small">
                     <div>
                         <span class="badge bg-primary me-1">TC</span> Tiempo Completo
                         <span class="badge bg-info ms-2 me-1">PA</span> Por Asignatura
                     </div>
                     <div>
                         <i class="fas fa-info-circle me-1"></i>
                         Los cambios se resaltar치n antes de guardar.
                     </div>
                 </div>
            </div>
        </div>
    </form>
    {% else %}
    <div class="alert alert-info border-0 shadow-sm d-flex align-items-center p-4">
        <i class="fas fa-search fa-2x me-3 text-info"></i>
        <div>
            <h5 class="alert-heading">No se encontraron resultados</h5>
            <p class="mb-0">Prueba ajustando los filtros de cuatrimestre para ver la matriz de asignaci칩n.</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Ayuda -->
{% include 'ayuda_modal_partial.html' ignore missing %} 

<style>
    .avatar-circle-sm {
        width: 40px; height: 40px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%;
        background-color: #f8f9fa;
    }
    
    .cursor-pointer { cursor: pointer; }
    
    .cell-hover:hover {
        background-color: rgba(0,0,0,0.02);
    }
    
    /* Crosshair effect improved */
    .table-hover tbody tr:hover td {
        background-color: rgba(0,0,0,0.03); /* Highlight row */
    }
    .table-hover tbody tr:hover th {
        background-color: #f8f9fa;
    }

    /* Disable global table hover transform */
    .table tbody tr:hover {
        transform: none !important;
        box-shadow: none !important;
        z-index: auto !important;
    }
    
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .tracking-wider { letter-spacing: 0.05em; }
    
    .group-hover-visible { opacity: 0; transition: opacity 0.2s; }
    .group-hover-target:hover .group-hover-visible { opacity: 0.5; }
    
    /* Custom scrollbar for matrix */
    .table-responsive::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .table-responsive::-webkit-scrollbar-thumb {
        background-color: #cbd3da;
        border-radius: 4px;
    }
    .table-responsive::-webkit-scrollbar-track {
        background-color: #f1f1f1;
    }
</style>

<script>
const asignacionesOriginales = new Set();
{% for profesor_id, materias_ids in asignaciones_actuales.items() %}
    {% for materia_id in materias_ids %}
        asignacionesOriginales.add('{{ profesor_id }}-{{ materia_id }}');
    {% endfor %}
{% endfor %}

function actualizarContador(checkbox) {
    if(checkbox) {
        // Visual effect for change
        const cell = checkbox.closest('label');
        if(checkbox.checked) {
             const original = asignacionesOriginales.has(checkbox.value);
             cell.className = `d-flex align-items-center justify-content-center w-100 h-100 py-3 cursor-pointer ${original ? 'bg-primary bg-opacity-10' : 'bg-success bg-opacity-25'}`;
        } else {
             const original = asignacionesOriginales.has(checkbox.value);
             cell.className = `d-flex align-items-center justify-content-center w-100 h-100 py-3 cursor-pointer ${original ? 'bg-danger bg-opacity-10' : ''}`;
        }
    }

    const checkboxes = document.querySelectorAll('.assignment-check');
    const asignacionesActuales = new Set();
    
    checkboxes.forEach(cb => {
        if (cb.checked) asignacionesActuales.add(cb.value);
    });
    
    let cambios = 0;
    asignacionesActuales.forEach(valor => {
        if (!asignacionesOriginales.has(valor)) cambios++;
    });
    asignacionesOriginales.forEach(valor => {
        if (!asignacionesActuales.has(valor)) cambios++;
    });
    
    const contadorBadge = document.getElementById('contadorCambios');
    contadorBadge.textContent = cambios;
    
    if (cambios > 0) {
        contadorBadge.classList.add('text-danger');
    } else {
        contadorBadge.classList.remove('text-danger');
    }
}

function seleccionarTodas() {
    document.querySelectorAll('.assignment-check').forEach(cb => {
        cb.checked = true;
        actualizarContador(cb);
    });
}

function limpiarSeleccion() {
    document.querySelectorAll('.assignment-check').forEach(cb => {
        cb.checked = false;
        actualizarContador(cb);
    });
}

function seleccionarFila(profesorId) {
    const checkboxes = document.querySelectorAll(`[data-profesor="${profesorId}"]`);
    const todosSeleccionados = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => {
        cb.checked = !todosSeleccionados;
        actualizarContador(cb);
    });
}

function seleccionarColumna(columnaIndex) {
    const selector = columnaIndex === -1 ? '.assignment-check' : `[data-columna="${columnaIndex}"]`;
    const checkboxes = document.querySelectorAll(selector);
    const todosSeleccionados = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => {
        cb.checked = !todosSeleccionados;
        actualizarContador(cb);
    });
}

window.addEventListener('beforeunload', function (e) {
    if (parseInt(document.getElementById('contadorCambios').textContent) > 0) {
        e.preventDefault(); e.returnValue = '';
    }
});
</script>
{% endblock %}
